---
title: 54. Развертывание приложений Kubernetes 
description: 
toc: true
authors:
tags: [devops]
categories:
series: 
date: "2022-06-13"
lastMod: "2022-06-13"
featuredImage:
draft: false
id: 1048764
weight: 54
---
## Развертывание приложений Kubernetes

Теперь мы, наконец, переходим к реальному развертыванию некоторых приложений в наших кластерах, некоторые говорят, что именно для этого существует Kubernetes - для доставки приложений.

Идея заключается в том, что мы можем взять наши образы контейнеров и развернуть их в виде стручков в нашем кластере Kubernetes, чтобы воспользоваться преимуществами Kubernetes как контейнерного оркестратора.

### Развертывание приложений в Kubernetes

Существует несколько способов развертывания наших приложений в кластере Kubernetes, мы рассмотрим два наиболее распространенных подхода - YAML-файлы и диаграммы Helm.

Для развертывания приложений мы будем использовать кластер minikube. Мы рассмотрим некоторые из ранее упомянутых компонентов или строительных блоков Kubernetes.

На протяжении всего этого раздела и раздела о контейнерах мы говорили об образах и преимуществах Kubernetes, а также о том, как мы можем легко справляться с масштабированием на этой платформе.

В этом первом шаге мы просто создадим приложение без статических данных в нашем кластере minikube. Мы будем использовать дефакто стандартное приложение без статики в нашей первой демонстрации `nginx`. Мы настроим Deployment, который предоставит нам наши стручки, а затем мы также создадим службу, которая позволит нам перейти к простому веб-серверу, размещенному в стручке nginx. Все это будет содержаться в пространстве имен.

![](../images/Day54_Kubernetes1.ru.png?v1)

### Создание YAML

В первом демо мы хотим определить все, что мы делаем с YAML, мы могли бы создать целый раздел о YAML, но я собираюсь пропустить это и оставить некоторые ресурсы в конце, которые расскажут о YAML более подробно.

Мы можем создать следующее как один YAML-файл или разбить его на части для каждого аспекта нашего приложения, то есть это могут быть отдельные файлы для пространства имен, развертывания и создания сервисов, но в этом файле ниже мы разделили их с помощью `---` в одном файле. Вы можете найти этот файл, расположенный [здесь](../days\Kubernetes\nginx-stateless-demo.yaml)

```
apiVersion: v1
kind: Namespace
metadata:
  name: nginx
  "labels": {
    "name": "nginx"
  }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: nginx
spec:
  selector:
    app: nginx-deployment
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```

### Проверка нашего кластера

Перед тем как развернуть что-либо, мы должны убедиться, что у нас нет существующих пространств имен с названием `nginx`. Мы можем сделать это, выполнив команду `kubectl get namespace`, и как вы можете видеть ниже, у нас нет пространства имен с названием `nginx`.

![](../images/Day54_Kubernetes2.ru.png?v1)

### Время развернуть наше приложение

Теперь мы готовы развернуть наше приложение на нашем кластере minikube, этот же процесс будет работать на любом другом кластере Kubernetes.

Нам нужно перейти к расположению нашего yaml файла, а затем мы можем выполнить команду `kubectl create -f nginx-stateless-demo.yaml`, после чего вы увидите, что было создано 3 объекта, у нас есть пространство имен, развертывание и сервис.

![](../images/Day54_Kubernetes3.ru.png?v1)

Давайте снова выполним команду, чтобы увидеть доступные пространства имен в нашем кластере `kubectl get namespace`, и теперь вы можете увидеть, что у нас есть наше новое пространство имен.

![](../images/Day54_Kubernetes5.ru.png?v1)

Если мы затем проверим наше пространство имен на наличие стручков с помощью `kubectl get pods -n nginx`, вы увидите, что у нас есть 1 стручок в готовом и запущенном состоянии.

![](../images/Day54_Kubernetes4.ru.png?v1)

Мы также можем проверить, что наш сервис создан, выполнив команду `kubectl get service -n nginx`.

![](../images/Day54_Kubernetes6.ru.png?v1)

Наконец, мы можем пойти и проверить наше развертывание, развертывание - это то, где и как мы сохраняем нашу желаемую конфигурацию.

![](../images/Day54_Kubernetes7.ru.png?v1)

Выше приведено несколько команд, которые стоит знать, но вы также можете использовать `kubectl get all -n nginx`, чтобы увидеть все, что мы развернули с помощью одного YAML-файла.

![](../images/Day54_Kubernetes8.ru.png?v1)

Вы можете заметить, что у нас также есть replicaset, в нашем развертывании мы определяем, сколько копий нашего образа мы хотим развернуть. Изначально мы установили значение 1, но если мы хотим быстро масштабировать наше приложение, мы можем сделать это несколькими способами.

Мы можем отредактировать наш файл с помощью команды `kubectl edit deployment nginx-deployment -n nginx`, которая откроет текстовый редактор в вашем терминале и позволит вам изменить развертывание.

![](../images/Day54_Kubernetes9.ru.png?v1)

После сохранения в текстовом редакторе в терминале, если не возникло проблем и было использовано правильное форматирование, вы должны увидеть дополнительное развертывание в вашем пространстве имен.

![](../images/Day54_Kubernetes10.ru.png?v1)

Мы также можем изменить количество реплик с помощью kubectl и команды `kubectl scale deployment nginx-deployment --replicas=10 -n nginx`.

![](../images/Day54_Kubernetes11.ru.png?v1)

Мы также можем использовать этот метод для уменьшения масштаба нашего приложения до 1 снова, если захотим, используя любой метод. Я использовал опцию edit, но вы также можете использовать команду scale выше.

![](../images/Day54_Kubernetes12.ru.png?v1)

Надеюсь, здесь вы можете увидеть пример использования: не только все очень быстро запускается и выключается, но у нас есть возможность быстро увеличивать и уменьшать масштаб наших приложений. Если бы это был веб-сервер, мы могли бы увеличивать масштаб в периоды загруженности и уменьшать, когда нагрузка снижается.

### Раскрытие нашего приложения

Но как нам получить доступ к нашему веб-серверу?

Если вы посмотрите выше на наш сервис, вы увидите, что там нет внешнего IP, поэтому мы не можем просто открыть веб-браузер и ожидать, что он будет там волшебным образом. Для доступа у нас есть несколько вариантов.

**ClusterIP** - IP, который вы видите, является кластерным IP, он находится во внутренней сети кластера. Только объекты внутри кластера могут достичь этого IP.

**NodePort** - Выставляет службу на один и тот же порт каждого из выбранных узлов в кластере с помощью NAT.

**LoadBalancer** - Создает внешний балансировщик нагрузки в текущем облаке, мы используем minikube, но если вы создали свой собственный кластер Kubernetes, т.е. то, что мы сделали в VirtualBox, вам нужно будет развернуть LoadBalancer, такой как metallb, в вашем кластере, чтобы обеспечить эту функциональность.  

**Port-Forward** - У нас также есть возможность Port Forward, которая позволяет вам получить доступ и взаимодействовать с внутренними процессами кластера Kubernetes с вашего localhost. На самом деле эта опция используется только для тестирования и поиска неисправностей.

Теперь у нас есть несколько вариантов на выбор, Minikube имеет некоторые ограничения или отличия от полноценного кластера Kubernetes.

Мы можем просто выполнить следующую команду, чтобы перенаправить порт для доступа, используя нашу локальную рабочую станцию.

`kubectl port-forward deployment/nginx-deployment -n nginx 8090:80`.

![](../images/Day54_Kubernetes13.ru.png?v1)

Обратите внимание, что при выполнении вышеуказанной команды терминал становится непригодным для использования, поскольку он действует как проброс порта на вашу локальную машину и порт.

![](../images/Day54_Kubernetes15.ru.png?v1)

Наконец, в новом терминале запустите `minikube --profile='mc-demo' service nginx-service --url -n nginx`, чтобы создать туннель для нашего сервиса.

![](../images/Day54_Kubernetes16.ru.png?v1)

Откройте браузер или программу управления и нажмите на ссылку в терминале.

### Helm

Helm - это еще один способ, с помощью которого мы можем развернуть наши приложения. Известен как "менеджер пакетов для Kubernetes". Вы можете узнать больше [здесь](https://helm.sh/).

Helm - это менеджер пакетов для Kubernetes. Helm можно считать аналогом yum или apt для Kubernetes. Helm развертывает диаграммы, которые можно представить как упакованное приложение. Это чертеж предварительно сконфигурированных ресурсов приложения, которые можно развернуть в виде одной простой в использовании диаграммы. Затем вы можете развернуть другую версию диаграммы с другим набором конфигураций.

У компании есть сайт, на котором можно просмотреть все доступные диаграммы Helm и, конечно, создать свою собственную. Документация также понятна и лаконична и не так пугает, как когда я впервые услышал термин Helm среди всех других новых слов в этой области.

Запустить или установить Helm очень просто. Просто. Здесь вы можете найти двоичные файлы и ссылки на загрузку практически для всех дистрибутивов, включая устройства RaspberryPi arm64.

Или вы можете использовать скрипт установщика, преимущество которого в том, что будет загружена и установлена последняя версия Helm.

```
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3

chmod 700 get_helm.sh

./get_helm.sh
```

Наконец, есть также возможность использовать менеджер пакетов для менеджера приложений, homebrew для mac, chocolatey для windows, apt с Ubuntu/Debian, snap и pkg также.

Пока что Helm кажется наиболее удобным способом загрузки и установки различных тестовых приложений в кластере.

Хорошим ресурсом для ссылки здесь будет [ArtifactHUB](https://artifacthub.io/), который является ресурсом для поиска, установки и публикации пакетов Kubernetes. Я также порекомендую [KubeApps](https://kubeapps.com/), который представляет собой пользовательский интерфейс для отображения диаграмм штурвала.

## Ресурсы

- [Kubernetes Documentation](https://kubernetes.io/docs/home/)
- [TechWorld with Nana - Kubernetes Tutorial for Beginners [FULL COURSE in 4 Hours]](https://www.youtube.com/watch?v=X48VuDVv0do)
- [TechWorld with Nana - Kubernetes Crash Course for Absolute Beginners](https://www.youtube.com/watch?v=s_o8dwzRlu4)
- [Kunal Kushwaha - Kubernetes Tutorial for Beginners | What is Kubernetes? Architecture Simplified!](https://www.youtube.com/watch?v=KVBON1lA9N8)
